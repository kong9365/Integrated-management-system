## 스토리지 무결성 진단 및 개선 요약

### 1. 기존 JSON 저장 로직 분석
- `server/routes/visitors.ts` 내 `readFileSync`/`writeFileSync` 조합으로 단일 JSON 파일을 직접 갱신.
- 쓰기 동작 중 예외가 발생하면 기존 파일이 부분적으로만 기록될 위험 존재.
- 동시 요청이 겹칠 경우, 쓰기 중간에 다른 요청이 동일 파일을 열어 덮어쓸 수 있어 데이터 손상 가능.
- Audit Trail 또한 동일 구조로 저장되어, 기록 누락/중복 가능성이 있음.

### 2. 리스크 요약
| 위험 항목 | 설명 | 영향 |
| --- | --- | --- |
| 부분 쓰기 실패 | 예외 발생 시 JSON 파일이 손상된 상태로 남음 | 방문자/감사 로그 전체 손실 |
| 동시성 충돌 | 동시에 write 수행 시 마지막 요청만 반영 | 데이터 유실, 감사 추적 무력화 |
| 원복 경로 부재 | 백업/복구 절차 없음 | 장애 발생 시 복구 지연 |

### 3. 개선 내용
1. **원자적 쓰기(Atomic Write)**  
   - `server/utils/fileStore.ts` 도입. 임시 파일(`*.tmp`)에 먼저 저장 후 `renameSync`로 교체.
   - 동일 디렉터리 내 원자적 rename 을 이용해 부분 쓰기 위험 제거.

2. **파일 잠금(File Lock) & 동시성 제어**  
   - `.lock` 파일을 활용한 교착 방지 잠금 구현.  
   - 락을 보유한 동안 다른 요청은 대기하며, 타임아웃(기본 5초) 초과 시 오류를 발생시켜 이상 상황 감지.

3. **단위 테스트 추가**  
   - `server/utils/fileStore.test.ts`에서 Atomic Write/Lock 경합 시나리오 검증.  
   - CI/로컬에서 `npm run test:fileStore`로 실행 가능.

### 4. 기대 효과
- 부분 쓰기/경쟁 조건 제거로 데이터 무결성 강화.
- 잠금 실패/타임아웃 시 명확한 에러 로그를 남겨 운영 가시성 확보.
- 테스트 자동화를 통한 회귀 방지.

### 5. 향후 조치
- 파일 기반 저장소 유지 기간 동안 정기적으로 `fileStore` 모듈 상태 점검.
- 필요 시 SQLite/PostgreSQL 등 트랜잭션 DB로 마이그레이션 로드맵 수립.

