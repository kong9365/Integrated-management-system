/**
 * ì‹œí—˜ì¥ë¹„ ê°€ë™ë¥  í˜ì´ì§€
 * Python integrated_dashboard.pyì™€ ë™ì¼í•œ ë””ìì¸ ë° ê¸°ëŠ¥ êµ¬í˜„
 */

import { useState } from "react";
import { useLocation } from "wouter";
import { useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Checkbox } from "@/components/ui/checkbox";
import { ArrowLeft, RefreshCw } from "lucide-react";
import {
  BarChart,
  Bar,
  PieChart,
  Pie,
  Cell,
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from "recharts";
import { subDays, format } from "date-fns";
import { DatePickerWithRange } from "@/components/ui/date-picker-range";
import { collectDataNow } from "@/lib/cds-api";

interface SessionRecord {
  ì§‘ê³„ì¼ì: string;
  ì¥ë¹„: string;
  ì‹œí—˜ì: string;
  acquisitionMethod: string;
  ìƒ˜í”Œëª…: string;
  ê°€ë™ì‹œê°„_h: number;
  ì„¸ì…˜ì‹œì‘?: string;
  ì„¸ì…˜ì¢…ë£Œ?: string;
}

interface UtilizationResponse {
  success: boolean;
  data: SessionRecord[];
  count: number;
}

interface StatsResponse {
  success: boolean;
  data: {
    equipmentRanking: Array<{ ìˆœìœ„: number; ì¥ë¹„: string; ê°€ë™ì‹œê°„_h: number }>;
    userRanking: Array<{ ìˆœìœ„: number; ì‹œí—˜ì: string; ê°€ë™ì‹œê°„_h: number }>;
  };
}

interface OptionsResponse {
  success: boolean;
  data: {
    equipment: Array<{ label: string; value: string }>;
    users: Array<{ label: string; value: string }>;
    analysis: Array<{ label: string; value: string }>;
    products?: Array<{ label: string; value: string }>;
    timeperiods?: Array<{ label: string; value: string }>;
  };
}

const COLORS = [
  "#8884d8",
  "#82ca9d",
  "#ffc658",
  "#ff7300",
  "#00ff00",
  "#0088fe",
  "#ff00ff",
  "#ff0000",
];

export default function EquipmentRate() {
  const [, setLocation] = useLocation();
  const [selectedEquipment, setSelectedEquipment] = useState<string[]>([]);
  const [selectedUsers, setSelectedUsers] = useState<string[]>([]);
  const [selectedAnalysis, setSelectedAnalysis] = useState<string[]>([]);
  const [selectedProducts, setSelectedProducts] = useState<string[]>([]);
  const [selectedTimeperiods, setSelectedTimeperiods] = useState<string[]>([]);
  const [dateRange, setDateRange] = useState<{ from: Date; to: Date }>({
    from: subDays(new Date(), 30),
    to: new Date(),
  });
  const [activeTab, setActiveTab] = useState<"equipment" | "analysis" | "data">("equipment");

  // í•„í„° ì˜µì…˜ ì¡°íšŒ
  const { data: optionsData } = useQuery<OptionsResponse>({
    queryKey: ["cds-utilization-options"],
    queryFn: async () => {
      const response = await fetch("/api/cds/utilization/options");
      if (!response.ok) {
        throw new Error("í•„í„° ì˜µì…˜ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
      }
      return response.json();
    },
    staleTime: 0, // í•­ìƒ ìµœì‹  ë°ì´í„° ì‚¬ìš©
    refetchOnMount: true, // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ í•­ìƒ ì¬ì¡°íšŒ
  });

  // ìˆ˜ë™ ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ (ê³µí†µ API ì‚¬ìš©)
  const handleManualCollect = async () => {
    const success = await collectDataNow();
    if (success) {
      // ìˆ˜ì§‘ ì„±ê³µ í›„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
      setTimeout(() => {
        refetch();
        refetchStats();
      }, 1000);
    }
  };

  // ê°€ë™ë¥  ë°ì´í„° ì¡°íšŒ
  const { data: utilizationData, isLoading, refetch } = useQuery<UtilizationResponse>({
    queryKey: [
      "cds-utilization",
      dateRange.from,
      dateRange.to,
      selectedEquipment,
      selectedUsers,
      selectedAnalysis,
      selectedProducts,
      selectedTimeperiods,
    ],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (dateRange.from) {
        params.append("startDate", format(dateRange.from, "yyyy-MM-dd"));
      }
      if (dateRange.to) {
        params.append("endDate", format(dateRange.to, "yyyy-MM-dd"));
      }
      if (selectedEquipment.length > 0) {
        selectedEquipment.forEach((eq) => params.append("equipment", eq));
      }
      if (selectedUsers.length > 0) {
        selectedUsers.forEach((user) => params.append("user", user));
      }
      if (selectedAnalysis.length > 0) {
        selectedAnalysis.forEach((analysis) => params.append("analysis", analysis));
      }
      if (selectedProducts.length > 0) {
        selectedProducts.forEach((product) => params.append("product", product));
      }
      if (selectedTimeperiods.length > 0) {
        selectedTimeperiods.forEach((tp) => params.append("timeperiod", tp));
      }

      const response = await fetch(`/api/cds/utilization?${params.toString()}`);
      if (!response.ok) {
        throw new Error("ê°€ë™ë¥  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
      }
      return response.json();
    },
    staleTime: 0, // í•­ìƒ ìµœì‹  ë°ì´í„° ì‚¬ìš©
    refetchOnMount: true, // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ í•­ìƒ ì¬ì¡°íšŒ
    refetchInterval: 120000, // 2ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹ 
  });

  // í†µê³„ ë°ì´í„° ì¡°íšŒ
  const { data: statsData, refetch: refetchStats } = useQuery<StatsResponse>({
    queryKey: [
      "cds-utilization-stats",
      dateRange.from,
      dateRange.to,
      selectedEquipment,
      selectedUsers,
      selectedAnalysis,
      selectedProducts,
      selectedTimeperiods,
    ],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (dateRange.from) {
        params.append("startDate", format(dateRange.from, "yyyy-MM-dd"));
      }
      if (dateRange.to) {
        params.append("endDate", format(dateRange.to, "yyyy-MM-dd"));
      }
      if (selectedEquipment.length > 0) {
        selectedEquipment.forEach((eq) => params.append("equipment", eq));
      }
      if (selectedUsers.length > 0) {
        selectedUsers.forEach((user) => params.append("user", user));
      }
      if (selectedAnalysis.length > 0) {
        selectedAnalysis.forEach((analysis) => params.append("analysis", analysis));
      }
      if (selectedProducts.length > 0) {
        selectedProducts.forEach((product) => params.append("product", product));
      }
      if (selectedTimeperiods.length > 0) {
        selectedTimeperiods.forEach((tp) => params.append("timeperiod", tp));
      }

      const response = await fetch(`/api/cds/utilization/stats?${params.toString()}`);
      if (!response.ok) {
        throw new Error("í†µê³„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
      }
      return response.json();
    },
    staleTime: 0, // í•­ìƒ ìµœì‹  ë°ì´í„° ì‚¬ìš©
    refetchOnMount: true, // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ í•­ìƒ ì¬ì¡°íšŒ
  });

  const sessions = utilizationData?.data || [];
  const equipmentRanking = statsData?.data?.equipmentRanking || [];
  const userRanking = statsData?.data?.userRanking || [];

  // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
  const equipmentUsageData = sessions.reduce((acc, session) => {
    const existing = acc.find((item) => item.ì¥ë¹„ === session.ì¥ë¹„);
    if (existing) {
      existing.ê°€ë™ì‹œê°„_h += session.ê°€ë™ì‹œê°„_h;
    } else {
      acc.push({ ì¥ë¹„: session.ì¥ë¹„, ê°€ë™ì‹œê°„_h: session.ê°€ë™ì‹œê°„_h });
    }
    return acc;
  }, [] as Array<{ ì¥ë¹„: string; ê°€ë™ì‹œê°„_h: number }>)
    .sort((a, b) => a.ê°€ë™ì‹œê°„_h - b.ê°€ë™ì‹œê°„_h);

  const analysisUsageData = sessions.reduce((acc, session) => {
    if (!session.acquisitionMethod) return acc;
    const existing = acc.find((item) => item.acquisitionMethod === session.acquisitionMethod);
    if (existing) {
      existing.ê°€ë™ì‹œê°„_h += session.ê°€ë™ì‹œê°„_h;
    } else {
      acc.push({
        acquisitionMethod: session.acquisitionMethod,
        ê°€ë™ì‹œê°„_h: session.ê°€ë™ì‹œê°„_h,
      });
    }
    return acc;
  }, [] as Array<{ acquisitionMethod: string; ê°€ë™ì‹œê°„_h: number }>)
    .sort((a, b) => b.ê°€ë™ì‹œê°„_h - a.ê°€ë™ì‹œê°„_h)
    .slice(0, 10);

  const trendData = sessions.reduce((acc, session) => {
    const date = session.ì§‘ê³„ì¼ì;
    const existing = acc.find((item) => item.ì§‘ê³„ì¼ì === date);
    if (existing) {
      existing.ê°€ë™ì‹œê°„_h += session.ê°€ë™ì‹œê°„_h;
    } else {
      acc.push({ ì§‘ê³„ì¼ì: date, ê°€ë™ì‹œê°„_h: session.ê°€ë™ì‹œê°„_h });
    }
    return acc;
  }, [] as Array<{ ì§‘ê³„ì¼ì: string; ê°€ë™ì‹œê°„_h: number }>)
    .sort((a, b) => a.ì§‘ê³„ì¼ì.localeCompare(b.ì§‘ê³„ì¼ì));

  const handleSelectAll = (type: "equipment" | "user" | "analysis" | "product" | "timeperiod") => {
    if (!optionsData?.data) return;
    if (type === "equipment") {
      setSelectedEquipment(optionsData.data.equipment.map((eq) => eq.value));
    } else if (type === "user") {
      setSelectedUsers(optionsData.data.users.map((user) => user.value));
    } else if (type === "analysis") {
      setSelectedAnalysis(optionsData.data.analysis.map((analysis) => analysis.value));
    } else if (type === "product" && optionsData.data.products) {
      setSelectedProducts(optionsData.data.products.map((product) => product.value));
    } else if (type === "timeperiod" && optionsData.data.timeperiods) {
      setSelectedTimeperiods(optionsData.data.timeperiods.map((tp) => tp.value));
    }
  };

  const handleDeselectAll = (type: "equipment" | "user" | "analysis" | "product" | "timeperiod") => {
    if (type === "equipment") {
      setSelectedEquipment([]);
    } else if (type === "user") {
      setSelectedUsers([]);
    } else if (type === "analysis") {
      setSelectedAnalysis([]);
    } else if (type === "product") {
      setSelectedProducts([]);
    } else if (type === "timeperiod") {
      setSelectedTimeperiods([]);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ */}
      <div className="bg-white border-b border-gray-200 px-5 py-3 shadow-sm">
        <Button
          variant="ghost"
          className="mb-2"
          onClick={() => setLocation("/menu")}
          data-testid="button-back"
        >
          <ArrowLeft className="mr-2 h-4 w-4" />
          ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
        </Button>
      </div>

      {/* ë„¤ë¹„ê²Œì´ì…˜ ë°” */}
      <div className="bg-white border-b border-gray-200 px-5 py-3 shadow-sm">
        <div className="flex items-center gap-2">
          <span className="text-xl font-bold text-red-600">KWANG DONG</span>
          <span className="text-xl font-bold text-gray-700">PHARMACEUTICAL CO., LTD.</span>
          <span className="text-sm text-blue-600 ml-10">OpenLab CDS Instrument Dashboard (ì‹¤ì‹œê°„)</span>
        </div>
      </div>

      <div className="flex min-h-[calc(100vh-80px)]">
        {/* ì‚¬ì´ë“œë°” */}
        <div className="w-64 min-w-[250px] bg-white border-r border-gray-200 p-5 shadow-sm">
          {/* ì‹¤ì‹œê°„ ìƒíƒœ */}
          <div className="mb-5">
            <label className="block font-bold mb-2 text-sm text-gray-700">ğŸ”´ ì‹¤ì‹œê°„ ìƒíƒœ:</label>
            <div className="text-sm text-gray-600">
              {isLoading ? "ë¡œë”© ì¤‘..." : `í™œì„± - ${sessions.length}ê±´ ì„¸ì…˜`}
            </div>
          </div>

          {/* ì¥ë¹„ ì„ íƒ */}
          <div className="mb-5">
            <label className="block font-bold mb-2 text-sm text-gray-700">ì¥ë¹„ ì„ íƒ:</label>
            <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-md p-2 mb-2">
              {optionsData?.data.equipment.map((eq) => (
                <div key={eq.value} className="flex items-center space-x-2 py-1">
                  <Checkbox
                    id={`eq-${eq.value}`}
                    checked={selectedEquipment.includes(eq.value)}
                    onCheckedChange={(checked) => {
                      if (checked) {
                        setSelectedEquipment([...selectedEquipment, eq.value]);
                      } else {
                        setSelectedEquipment(selectedEquipment.filter((v) => v !== eq.value));
                      }
                    }}
                  />
                  <label
                    htmlFor={`eq-${eq.value}`}
                    className="text-sm cursor-pointer flex-1"
                  >
                    {eq.label}
                  </label>
                </div>
              ))}
            </div>
            <div className="flex gap-1">
              <Button
                variant="outline"
                size="sm"
                className="text-xs px-2 py-1 h-6"
                onClick={() => handleSelectAll("equipment")}
              >
                Select All
              </Button>
              <Button
                variant="outline"
                size="sm"
                className="text-xs px-2 py-1 h-6"
                onClick={() => handleDeselectAll("equipment")}
              >
                Deselect All
              </Button>
            </div>
          </div>

          {/* ë‚ ì§œ ì„ íƒ */}
          <div className="mb-5">
            <label className="block font-bold mb-2 text-sm text-gray-700">ë‚ ì§œ ì„ íƒ:</label>
            <DatePickerWithRange
              date={dateRange}
              onDateChange={setDateRange}
            />
          </div>

          {/* ì‚¬ìš©ì ì„ íƒ */}
          <div className="mb-5">
            <label className="block font-bold mb-2 text-sm text-gray-700">ì‚¬ìš©ì ì„ íƒ:</label>
            <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-md p-2 mb-2">
              {optionsData?.data.users.map((user) => (
                <div key={user.value} className="flex items-center space-x-2 py-1">
                  <Checkbox
                    id={`user-${user.value}`}
                    checked={selectedUsers.includes(user.value)}
                    onCheckedChange={(checked) => {
                      if (checked) {
                        setSelectedUsers([...selectedUsers, user.value]);
                      } else {
                        setSelectedUsers(selectedUsers.filter((v) => v !== user.value));
                      }
                    }}
                  />
                  <label
                    htmlFor={`user-${user.value}`}
                    className="text-sm cursor-pointer flex-1"
                  >
                    {user.label}
                  </label>
                </div>
              ))}
            </div>
            <div className="flex gap-1">
              <Button
                variant="outline"
                size="sm"
                className="text-xs px-2 py-1 h-6"
                onClick={() => handleSelectAll("user")}
              >
                Select All
              </Button>
              <Button
                variant="outline"
                size="sm"
                className="text-xs px-2 py-1 h-6"
                onClick={() => handleDeselectAll("user")}
              >
                Deselect All
              </Button>
            </div>
          </div>

          {/* ì œí’ˆ ì„ íƒ */}
          <div className="mb-5">
            <label className="block font-bold mb-2 text-sm text-gray-700">ì œí’ˆ ì„ íƒ:</label>
            <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-md p-2 mb-2">
              {optionsData?.data.products?.map((product) => (
                <div key={product.value} className="flex items-center space-x-2 py-1">
                  <Checkbox
                    id={`product-${product.value}`}
                    checked={selectedProducts.includes(product.value)}
                    onCheckedChange={(checked) => {
                      if (checked) {
                        setSelectedProducts([...selectedProducts, product.value]);
                      } else {
                        setSelectedProducts(selectedProducts.filter((v) => v !== product.value));
                      }
                    }}
                  />
                  <label
                    htmlFor={`product-${product.value}`}
                    className="text-sm cursor-pointer flex-1"
                  >
                    {product.label}
                  </label>
                </div>
              ))}
            </div>
            <div className="flex gap-1">
              <Button
                variant="outline"
                size="sm"
                className="text-xs px-2 py-1 h-6"
                onClick={() => handleSelectAll("product")}
              >
                Select All
              </Button>
              <Button
                variant="outline"
                size="sm"
                className="text-xs px-2 py-1 h-6"
                onClick={() => handleDeselectAll("product")}
              >
                Deselect All
              </Button>
            </div>
          </div>

          {/* ë¶„ì„ ì„ íƒ */}
          <div className="mb-5">
            <label className="block font-bold mb-2 text-sm text-gray-700">ë¶„ì„ ì„ íƒ:</label>
            <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-md p-2 mb-2">
              {optionsData?.data.analysis.map((analysis) => (
                <div key={analysis.value} className="flex items-center space-x-2 py-1">
                  <Checkbox
                    id={`analysis-${analysis.value}`}
                    checked={selectedAnalysis.includes(analysis.value)}
                    onCheckedChange={(checked) => {
                      if (checked) {
                        setSelectedAnalysis([...selectedAnalysis, analysis.value]);
                      } else {
                        setSelectedAnalysis(selectedAnalysis.filter((v) => v !== analysis.value));
                      }
                    }}
                  />
                  <label
                    htmlFor={`analysis-${analysis.value}`}
                    className="text-sm cursor-pointer flex-1"
                  >
                    {analysis.label}
                  </label>
                </div>
              ))}
            </div>
            <div className="flex gap-1">
              <Button
                variant="outline"
                size="sm"
                className="text-xs px-2 py-1 h-6"
                onClick={() => handleSelectAll("analysis")}
              >
                Select All
              </Button>
              <Button
                variant="outline"
                size="sm"
                className="text-xs px-2 py-1 h-6"
                onClick={() => handleDeselectAll("analysis")}
              >
                Deselect All
              </Button>
            </div>
          </div>

          {/* ì˜¤ì „/ì˜¤í›„ ì„ íƒ */}
          <div className="mb-5">
            <label className="block font-bold mb-2 text-sm text-gray-700">ì˜¤ì „/ì˜¤í›„ ì„ íƒ:</label>
            <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-md p-2 mb-2">
              {optionsData?.data.timeperiods?.map((tp) => (
                <div key={tp.value} className="flex items-center space-x-2 py-1">
                  <Checkbox
                    id={`timeperiod-${tp.value}`}
                    checked={selectedTimeperiods.includes(tp.value)}
                    onCheckedChange={(checked) => {
                      if (checked) {
                        setSelectedTimeperiods([...selectedTimeperiods, tp.value]);
                      } else {
                        setSelectedTimeperiods(selectedTimeperiods.filter((v) => v !== tp.value));
                      }
                    }}
                  />
                  <label
                    htmlFor={`timeperiod-${tp.value}`}
                    className="text-sm cursor-pointer flex-1"
                  >
                    {tp.label}
                  </label>
                </div>
              ))}
            </div>
            <div className="flex gap-1">
              <Button
                variant="outline"
                size="sm"
                className="text-xs px-2 py-1 h-6"
                onClick={() => handleSelectAll("timeperiod")}
              >
                Select All
              </Button>
              <Button
                variant="outline"
                size="sm"
                className="text-xs px-2 py-1 h-6"
                onClick={() => handleDeselectAll("timeperiod")}
              >
                Deselect All
              </Button>
            </div>
          </div>

          {/* ë‹¤ì‹œë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ */}
          <Button
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold mt-5"
            onClick={() => {
              refetch();
              refetchStats();
            }}
            disabled={isLoading}
          >
            <RefreshCw className={`mr-2 h-4 w-4 ${isLoading ? 'animate-spin' : ''}`} />
            ë‹¤ì‹œë¶ˆëŸ¬ì˜¤ê¸°
          </Button>
        </div>

        {/* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */}
        <div className="flex-1 p-5">
          {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
          <div className="bg-white border-b border-gray-200 mb-0">
            <div className="flex">
              <button
                className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                  activeTab === "equipment"
                    ? "border-blue-600 text-blue-600"
                    : "border-transparent text-gray-600 hover:text-blue-600"
                }`}
                onClick={() => setActiveTab("equipment")}
              >
                ğŸ“ˆ ì¥ë¹„ ê·¸ë˜í”„
              </button>
              <button
                className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                  activeTab === "analysis"
                    ? "border-blue-600 text-blue-600"
                    : "border-transparent text-gray-600 hover:text-blue-600"
                }`}
                onClick={() => setActiveTab("analysis")}
              >
                ğŸ“ˆ ë¶„ì„ ê·¸ë˜í”„
              </button>
              <button
                className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                  activeTab === "data"
                    ? "border-blue-600 text-blue-600"
                    : "border-transparent text-gray-600 hover:text-blue-600"
                }`}
                onClick={() => setActiveTab("data")}
              >
                ğŸ“‹ ë°ì´í„°
              </button>
            </div>
          </div>

          {/* íƒ­ ì½˜í…ì¸  */}
          <div className="bg-white p-5 rounded-b-lg">
            {activeTab === "equipment" ? (
              <div className="space-y-5">
                {/* ì¥ë¹„ë³„ ìš´ìš© ë¹„ìœ¨ ê·¸ë˜í”„ */}
                <div className="bg-white border border-gray-200 rounded-lg shadow-sm">
                  <div className="bg-gray-50 border-b border-gray-200 px-4 py-3 flex justify-between items-center rounded-t-lg">
                    <span className="font-bold text-sm">ğŸ˜„ ì¥ë¹„ë³„ ìš´ìš© ë¹„ìœ¨ - FILTER : ì¥ë¹„ + ê¸°ê°„</span>
                    <button className="text-gray-500 hover:text-gray-700">â›¶</button>
                  </div>
                  <div className="p-4" style={{ height: "60vh" }}>
                    {equipmentUsageData.length > 0 ? (
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={equipmentUsageData} layout="vertical">
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis type="number" />
                          <YAxis dataKey="ì¥ë¹„" type="category" width={150} />
                          <Tooltip />
                          <Bar dataKey="ê°€ë™ì‹œê°„_h" fill="#8884d8" />
                        </BarChart>
                      </ResponsiveContainer>
                    ) : (
                      <div className="flex items-center justify-center h-full text-gray-500">
                        ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                      </div>
                    )}
                  </div>
                </div>

                {/* ë¶„ì„ìš© ê·¸ë˜í”„ */}
                <div className="bg-white border border-gray-200 rounded-lg shadow-sm">
                  <div className="bg-gray-50 border-b border-gray-200 px-4 py-3 flex justify-between items-center rounded-t-lg">
                    <span className="font-bold text-sm">ë¶„ì„ìš© ê·¸ë˜í”„</span>
                    <button className="text-gray-500 hover:text-gray-700">â›¶</button>
                  </div>
                  <div className="p-4" style={{ height: "60vh" }}>
                    {trendData.length > 0 ? (
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={trendData}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="ì§‘ê³„ì¼ì" />
                          <YAxis />
                          <Tooltip />
                          <Legend />
                          <Line
                            type="monotone"
                            dataKey="ê°€ë™ì‹œê°„_h"
                            stroke="#8884d8"
                            strokeWidth={2}
                            dot={{ r: 4 }}
                          />
                        </LineChart>
                      </ResponsiveContainer>
                    ) : (
                      <div className="flex items-center justify-center h-full text-gray-500">
                        ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                      </div>
                    )}
                  </div>
                </div>
              </div>
            ) : activeTab === "analysis" ? (
              <div className="space-y-5">
                {/* ë¶„ì„ë³„ ìš´ìš© ë¹„ìœ¨ íŒŒì´ì°¨íŠ¸ */}
                <div className="bg-white border border-gray-200 rounded-lg shadow-sm">
                  <div className="bg-gray-50 border-b border-gray-200 px-4 py-3 flex justify-between items-center rounded-t-lg">
                    <span className="font-bold text-sm">ğŸ“Š ë¶„ì„ë³„ ìš´ìš© ë¹„ìœ¨</span>
                    <button className="text-gray-500 hover:text-gray-700">â›¶</button>
                  </div>
                  <div className="p-4" style={{ height: "60vh" }}>
                    {analysisUsageData.length > 0 ? (
                      <ResponsiveContainer width="100%" height="100%">
                        <PieChart>
                          <Pie
                            data={analysisUsageData}
                            dataKey="ê°€ë™ì‹œê°„_h"
                            nameKey="acquisitionMethod"
                            cx="50%"
                            cy="50%"
                            outerRadius={150}
                            label
                          >
                            {analysisUsageData.map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                            ))}
                          </Pie>
                          <Tooltip />
                        </PieChart>
                      </ResponsiveContainer>
                    ) : (
                      <div className="flex items-center justify-center h-full text-gray-500">
                        ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                      </div>
                    )}
                  </div>
                </div>
              </div>
            ) : (
              <div className="flex gap-5" style={{ height: "85vh" }}>
                {/* ì™¼ìª½: ì¥ë¹„ ìš´ìš©ì‹œê°„ í…Œì´ë¸” */}
                <div className="flex-1 bg-white border border-gray-200 rounded-lg shadow-sm">
                  <div className="bg-gray-50 border-b border-gray-200 px-4 py-3 rounded-t-lg">
                    <span className="font-bold text-sm">ğŸ•œ ì¥ë¹„ ìš´ìš©ì‹œê°„</span>
                  </div>
                  <div className="p-4 overflow-auto" style={{ height: "calc(85vh - 60px)" }}>
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>ì¥ë¹„</TableHead>
                          <TableHead>ë‚ ì§œ</TableHead>
                          <TableHead>ì‚¬ìš©ì‹œê°„(h)</TableHead>
                          <TableHead>ì‚¬ìš©ì</TableHead>
                          <TableHead>ë¶„ì„ë²•</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {sessions.map((session, index) => (
                          <TableRow key={index}>
                            <TableCell className="font-medium">{session.ì¥ë¹„}</TableCell>
                            <TableCell>{session.ì§‘ê³„ì¼ì}</TableCell>
                            <TableCell>{session.ê°€ë™ì‹œê°„_h.toFixed(2)}</TableCell>
                            <TableCell>{session.ì‹œí—˜ì || "-"}</TableCell>
                            <TableCell>{session.acquisitionMethod || "-"}</TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </div>
                </div>

                {/* ì˜¤ë¥¸ìª½: ë­í‚¹ í…Œì´ë¸”ë“¤ */}
                <div className="flex-1 space-y-5">
                  {/* ì¥ë¹„ ë­í‚¹ */}
                  <div className="bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div className="bg-gray-50 border-b border-gray-200 px-4 py-3 rounded-t-lg">
                      <span className="font-bold text-sm">ğŸ† ì¥ë¹„ Ranking</span>
                    </div>
                    <div className="p-4 overflow-auto" style={{ height: "35vh" }}>
                      <Table>
                        <TableHeader>
                          <TableRow>
                            <TableHead>ìˆœìœ„</TableHead>
                            <TableHead>ì¥ë¹„</TableHead>
                            <TableHead>ì‚¬ìš©ì‹œê°„(h)</TableHead>
                          </TableRow>
                        </TableHeader>
                        <TableBody>
                          {equipmentRanking.map((item) => (
                            <TableRow
                              key={item.ì¥ë¹„}
                              className={
                                item.ìˆœìœ„ === 1
                                  ? "bg-yellow-50"
                                  : item.ìˆœìœ„ === 2
                                  ? "bg-gray-50"
                                  : item.ìˆœìœ„ === 3
                                  ? "bg-gray-100"
                                  : ""
                              }
                            >
                              <TableCell>{item.ìˆœìœ„}</TableCell>
                              <TableCell className="font-medium">{item.ì¥ë¹„}</TableCell>
                              <TableCell>{item.ê°€ë™ì‹œê°„_h.toFixed(2)}</TableCell>
                            </TableRow>
                          ))}
                        </TableBody>
                      </Table>
                    </div>
                  </div>

                  {/* ì‚¬ìš©ì ë­í‚¹ */}
                  <div className="bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div className="bg-gray-50 border-b border-gray-200 px-4 py-3 rounded-t-lg">
                      <span className="font-bold text-sm">ğŸ† ì‚¬ìš©ì Ranking</span>
                    </div>
                    <div className="p-4 overflow-auto" style={{ height: "35vh" }}>
                      <Table>
                        <TableHeader>
                          <TableRow>
                            <TableHead>ìˆœìœ„</TableHead>
                            <TableHead>ì‚¬ìš©ì</TableHead>
                            <TableHead>ì‚¬ìš©ì‹œê°„(h)</TableHead>
                          </TableRow>
                        </TableHeader>
                        <TableBody>
                          {userRanking.map((item) => (
                            <TableRow
                              key={item.ì‹œí—˜ì}
                              className={
                                item.ìˆœìœ„ === 1
                                  ? "bg-blue-50"
                                  : item.ìˆœìœ„ === 2
                                  ? "bg-gray-50"
                                  : item.ìˆœìœ„ === 3
                                  ? "bg-gray-100"
                                  : ""
                              }
                            >
                              <TableCell>{item.ìˆœìœ„}</TableCell>
                              <TableCell className="font-medium">{item.ì‹œí—˜ì}</TableCell>
                              <TableCell>{item.ê°€ë™ì‹œê°„_h.toFixed(2)}</TableCell>
                            </TableRow>
                          ))}
                        </TableBody>
                      </Table>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
